<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Creation - Cultural Benchmark Annotation Tool</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
            font-size: 16px;
        }
        
        .login-form {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .login-btn:hover {
            background: #1e7e34;
        }
        
        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .loading {
            display: none;
            margin: 20px 0;
        }
        
        .loading i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-link {
            margin-top: 20px;
        }
        
        .back-link a {
            color: #28a745;
            text-decoration: none;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
        
        .main-app {
            display: none;
        }
        
        .user-info-bar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #28a745;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .guidelines-panel {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .guidelines-panel h3 {
            color: #155724;
            margin-bottom: 15px;
        }
        
        .guidelines-panel ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .guidelines-panel li {
            margin-bottom: 8px;
            color: #155724;
        }
        
        .topic-examples {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .topic-examples h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .topic-examples p {
            margin: 5px 0;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1><i class="fas fa-plus-circle"></i> Data Creation</h1>
            <p>Enter your User ID to start creating cultural benchmark data</p>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i> Validating user...
        </div>
        
        <form id="loginForm" class="login-form">
            <div class="form-group">
                <label for="userId">User ID:</label>
                <input type="text" id="userId" name="userId" required placeholder="Enter your user ID">
            </div>
            
            <button type="submit" id="loginBtn" class="login-btn">
                <i class="fas fa-rocket"></i> Start Creating Data
            </button>
        </form>
        
        <div class="back-link">
            <a href="index.html"><i class="fas fa-arrow-left"></i> Back to Main App</a> |
            <a href="data_modification.html"><i class="fas fa-edit"></i> Data Modification</a>
        </div>
    </div>

    <!-- Main Application (shown after successful login) -->
    <div id="mainApp" class="main-app">
        <div class="user-info-bar">
            <div class="user-details">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div><strong id="displayUserId">User</strong></div>
                    <div><small id="userRole">Creator</small> | <small>Creating new cultural data</small></div>
                </div>
            </div>
            <button id="logoutBtn" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        
        <div class="container">
            <header class="header">
                <div class="header-content">
                    <h1><i class="fas fa-plus-circle"></i> Data Creation Tool</h1>
                    <div class="header-actions">
                        <button id="loadMyDataBtn" class="btn btn-secondary">
                            <i class="fas fa-folder-open"></i> Load My Data
                        </button>
                        <button id="saveDataBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> Save to Firebase
                        </button>
                        <button id="exportDataBtn" class="btn btn-secondary">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                        <button id="importDataBtn" class="btn btn-secondary">
                            <i class="fas fa-file-import"></i> Import Data
                        </button>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="sidebar">
                    <div class="guidelines-panel">
                        <h3><i class="fas fa-lightbulb"></i> Creation Guidelines</h3>
                        <ul>
                            <li>Focus on culture-specific knowledge</li>
                            <li>Ensure factual correctness</li>
                            <li>Make questions challenging for LLMs</li>
                            <li>Use objective, brief answers</li>
                            <li>Provide clear explanations</li>
                        </ul>
                    </div>

                    <div class="stats-panel">
                        <h3>Statistics</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Items:</span>
                            <span id="totalCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Completed:</span>
                            <span id="completedCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Progress:</span>
                            <span id="progressPercent" class="stat-value">0%</span>
                        </div>
                    </div>

                    <div class="filter-panel">
                        <h3>Filters</h3>
                        <div class="filter-group">
                            <label for="topicFilter">Topic:</label>
                            <select id="topicFilter" class="filter-select">
                                <option value="">All Topics</option>
                                <option value="Belief">Belief</option>
                                <option value="Commerce">Commerce</option>
                                <option value="Education">Education</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Finance">Finance</option>
                                <option value="Food">Food</option>
                                <option value="Government">Government</option>
                                <option value="Habitat">Habitat</option>
                                <option value="Health">Health</option>
                                <option value="Heritage">Heritage</option>
                                <option value="Language">Language</option>
                                <option value="Pets">Pets</option>
                                <option value="Science">Science</option>
                                <option value="Social">Social</option>
                                <option value="Travel">Travel</option>
                                <option value="Work">Work</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="statusFilter">Status:</label>
                            <select id="statusFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="incomplete">Incomplete</option>
                            </select>
                        </div>
                        <button id="clearFilters" class="btn btn-outline">Clear Filters</button>
                    </div>

                    <div class="navigation-panel">
                        <h3>Navigation</h3>
                        <div class="nav-controls">
                            <button id="prevBtn" class="btn btn-outline">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span id="itemCounter" class="item-counter">0 / 0</span>
                            <button id="nextBtn" class="btn btn-outline">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="annotation-area">
                    <div class="annotation-form" id="annotationForm">
                        <div class="form-group">
                            <label for="topic">Topic: <span style="color: red;">*</span></label>
                            <select id="topic" class="form-select" required>
                                <option value="">Select a topic</option>
                                <option value="Belief">Belief</option>
                                <option value="Commerce">Commerce</option>
                                <option value="Education">Education</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Finance">Finance</option>
                                <option value="Food">Food</option>
                                <option value="Government">Government</option>
                                <option value="Habitat">Habitat</option>
                                <option value="Health">Health</option>
                                <option value="Heritage">Heritage</option>
                                <option value="Language">Language</option>
                                <option value="Pets">Pets</option>
                                <option value="Science">Science</option>
                                <option value="Social">Social</option>
                                <option value="Travel">Travel</option>
                                <option value="Work">Work</option>
                            </select>
                            <div id="topicExamples" class="topic-examples" style="display: none;">
                                <h4>Topic Examples:</h4>
                                <p id="topicDescription"></p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="scenario">Scenario: <span style="color: red;">*</span></label>
                            <textarea id="scenario" class="form-textarea" rows="3" placeholder="Describe a plausible real-world situation" required></textarea>
                            <small class="form-help">Construct a plausible real-world situation, withholding explicit hints that would let a model solve the task without cultural knowledge.</small>
                        </div>

                        <div class="form-group">
                            <label for="question">Question: <span style="color: red;">*</span></label>
                            <textarea id="question" class="form-textarea" rows="3" placeholder="Enter the question that arises from the scenario" required></textarea>
                            <small class="form-help">Ensure the query arises naturally from the scenario and cannot be answered correctly without cultural knowledge.</small>
                        </div>

                        <div class="form-group">
                            <label for="answer">Answer: <span style="color: red;">*</span></label>
                            <textarea id="answer" class="form-textarea" rows="4" placeholder="Provide the correct answer (objective and brief)" required></textarea>
                            <small class="form-help">Answers should be objective and as brief as possible. Use multiple-choice format (A-D) if needed.</small>
                        </div>

                        <div class="form-group">
                            <label for="explanation">Explanation: <span style="color: red;">*</span></label>
                            <textarea id="explanation" class="form-textarea" rows="4" placeholder="Explain the cultural or domain knowledge that supports the answer" required></textarea>
                            <small class="form-help">Supply the cultural or domain knowledge that supports the answer.</small>
                        </div>

                        <div class="form-actions">
                            <button id="addNewBtn" class="btn btn-success">
                                <i class="fas fa-plus"></i> Add New Item
                            </button>
                            <button id="updateBtn" class="btn btn-primary" style="display: none;">
                                <i class="fas fa-check"></i> Update Item
                            </button>
                            <button id="deleteBtn" class="btn btn-danger" style="display: none;">
                                <i class="fas fa-trash"></i> Delete Item
                            </button>
                            <button id="clearFormBtn" class="btn btn-outline">
                                <i class="fas fa-eraser"></i> Clear Form
                            </button>
                        </div>
                    </div>

                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-content">
                            <i class="fas fa-plus-circle empty-state-icon"></i>
                            <h3>Start Creating Data</h3>
                            <p>Create your first cultural benchmark annotation item using the form above.</p>
                            <button id="startBtn" class="btn btn-success">
                                <i class="fas fa-plus"></i> Add First Item
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- File input for data import -->
    <input type="file" id="csvFileInput" accept=".csv,.xlsx" style="display: none;">

    <script src="app.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let annotationData = [];
        let currentIndex = -1; // -1 means new item mode
        let filteredData = [];

        // Topic descriptions for guidance
        const topicDescriptions = {
            'Belief': 'Systems of conviction that shape values, rituals, institutions, life-cycle events, and views on existence.',
            'Commerce': 'Buying, selling, marketing, and payment of goods and services across various platforms.',
            'Education': 'Formal and informal learning, teaching, research, and skill-building for all ages and settings.',
            'Entertainment': 'Media, arts, sports, games, performances, hobbies, and events created for leisure.',
            'Finance': 'Earning, saving, budgeting, investing, insuring, transferring, and distributing wealth.',
            'Food': 'Agriculture, sourcing, processing, cooking, nutrition, beverages, and dining culture.',
            'Government': 'Public policy, legislation, courts, law enforcement, defense, and civic administration.',
            'Habitat': 'Homes, buildings, infrastructure, utilities, urban planning, and sustainability practices.',
            'Health': 'Physical, mental, and emotional well-being—prevention, treatment, fitness, and wellness.',
            'Heritage': 'Past events, living traditions, festivals, monuments, and cultural inheritances.',
            'Language': 'Official and minority languages, scripts, dialects, idioms, and communication norms.',
            'Pets': 'Care, health, training, companionship, and welfare of domesticated animals.',
            'Science': 'Systematic inquiry into the natural world and its applications—research and technology.',
            'Social': 'Family, friendships, romance, community networks, demographics, and social issues.',
            'Travel': 'Planning, transport, logistics, accommodation, tourism, and movement of people.',
            'Work': 'Careers, labor markets, workplaces, productivity tools, and professional development.'
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Set up event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('loadMyDataBtn').addEventListener('click', loadUserData);
            document.getElementById('saveDataBtn').addEventListener('click', saveData);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('csvFileInput').click());
            document.getElementById('csvFileInput').addEventListener('change', handleFileImport);
            
            // Navigation
            document.getElementById('prevBtn').addEventListener('click', () => navigateItem(-1));
            document.getElementById('nextBtn').addEventListener('click', () => navigateItem(1));
            
            // Form actions
            document.getElementById('addNewBtn').addEventListener('click', addNewItem);
            document.getElementById('updateBtn').addEventListener('click', updateCurrentItem);
            document.getElementById('deleteBtn').addEventListener('click', deleteCurrentItem);
            document.getElementById('clearFormBtn').addEventListener('click', clearForm);
            document.getElementById('startBtn').addEventListener('click', () => {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('annotationForm').style.display = 'block';
                document.getElementById('topic').focus();
            });
            
            // Topic selection
            document.getElementById('topic').addEventListener('change', showTopicExamples);
            
            // Filters
            document.getElementById('topicFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            // Auto-save functionality
            const formInputs = ['topic', 'scenario', 'question', 'answer', 'explanation'];
            formInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', debounce(autoSave, 1000));
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                showError('Please enter a valid User ID');
                return;
            }
            
            showLoading(true);
            hideMessages();
            
            try {
                // For data creation, we just need to validate the user exists
                // We don't require special permissions like data modification
                const userResult = await FirebaseService.validateUserWithPermissions(userId);
                
                if (!userResult.success) {
                    // If user doesn't exist in the system, create a basic user record
                    currentUser = {
                        userId: userId,
                        role: 'creator',
                        language_code: ['all'],
                        canModifyData: false
                    };
                } else {
                    currentUser = userResult.user;
                }
                
                // Show success and switch to main app
                showSuccess('Login successful! Welcome to the data creation tool.');
                
                setTimeout(() => {
                    showMainApp();
                    updateUserInfo();
                    // Show empty state initially
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('annotationForm').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function handleLogout() {
            currentUser = null;
            annotationData = [];
            currentIndex = -1;
            filteredData = [];
            
            // Reset form
            document.getElementById('loginForm').reset();
            clearForm();
            
            // Show login screen
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            
            hideMessages();
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            document.getElementById('displayUserId').textContent = currentUser.userId;
            
            // Set avatar initial
            const avatar = document.getElementById('userAvatar');
            avatar.textContent = currentUser.userId.charAt(0).toUpperCase();
        }

        function showTopicExamples() {
            const topic = document.getElementById('topic').value;
            const examplesDiv = document.getElementById('topicExamples');
            const descriptionP = document.getElementById('topicDescription');
            
            if (topic && topicDescriptions[topic]) {
                descriptionP.textContent = topicDescriptions[topic];
                examplesDiv.style.display = 'block';
            } else {
                examplesDiv.style.display = 'none';
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            showLoading(true);
            
            try {
                // Load user's created data
                const result = await FirebaseService.loadUserCreatedData(currentUser.userId);
                
                if (result.success) {
                    annotationData = result.data || [];
                    filteredData = [...annotationData];
                    currentIndex = annotationData.length > 0 ? 0 : -1;
                    
                    updateDisplay();
                    updateStats();
                    
                    if (annotationData.length > 0) {
                        document.getElementById('emptyState').style.display = 'none';
                        document.getElementById('annotationForm').style.display = 'block';
                        displayCurrentItem();
                    } else {
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('annotationForm').style.display = 'none';
                    }
                    
                    showSuccess(`Loaded ${annotationData.length} items successfully`);
                } else {
                    showError('Failed to load data: ' + result.error);
                }
                
            } catch (error) {
                console.error('Load data error:', error);
                showError('Failed to load data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayCurrentItem() {
            if (currentIndex === -1 || filteredData.length === 0) {
                // New item mode
                clearForm();
                document.getElementById('addNewBtn').style.display = 'inline-block';
                document.getElementById('updateBtn').style.display = 'none';
                document.getElementById('deleteBtn').style.display = 'none';
                return;
            }
            
            if (currentIndex < 0 || currentIndex >= filteredData.length) {
                clearForm();
                return;
            }
            
            const item = filteredData[currentIndex];
            
            // Fill form fields
            document.getElementById('topic').value = item.topic || '';
            document.getElementById('scenario').value = item.scenario || '';
            document.getElementById('question').value = item.question || '';
            document.getElementById('answer').value = item.answer || '';
            document.getElementById('explanation').value = item.explanation || '';
            
            // Show topic examples
            showTopicExamples();
            
            // Show update/delete buttons
            document.getElementById('addNewBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'inline-block';
            document.getElementById('deleteBtn').style.display = 'inline-block';
            
            updateNavigation();
        }

        function addNewItem() {
            if (!validateForm()) {
                return;
            }
            
            const newItem = {
                id: generateId(),
                topic: document.getElementById('topic').value,
                scenario: document.getElementById('scenario').value,
                question: document.getElementById('question').value,
                answer: document.getElementById('answer').value,
                explanation: document.getElementById('explanation').value,
                createdBy: currentUser.userId,
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            annotationData.push(newItem);
            filteredData = [...annotationData];
            currentIndex = annotationData.length - 1;
            
            updateStats();
            updateDisplay();
            displayCurrentItem();
            
            showSuccess('New item added successfully');
        }

        function updateCurrentItem() {
            if (currentIndex === -1 || !validateForm()) {
                return;
            }
            
            const item = filteredData[currentIndex];
            
            // Update item with form data
            item.topic = document.getElementById('topic').value;
            item.scenario = document.getElementById('scenario').value;
            item.question = document.getElementById('question').value;
            item.answer = document.getElementById('answer').value;
            item.explanation = document.getElementById('explanation').value;
            item.lastModified = new Date().toISOString();
            
            updateStats();
            showSuccess('Item updated successfully');
        }

        function deleteCurrentItem() {
            if (currentIndex === -1 || filteredData.length === 0) {
                return;
            }
            
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            
            const item = filteredData[currentIndex];
            const originalIndex = annotationData.findIndex(i => i.id === item.id);
            
            if (originalIndex !== -1) {
                annotationData.splice(originalIndex, 1);
                filteredData = [...annotationData];
                
                // Adjust current index
                if (currentIndex >= filteredData.length) {
                    currentIndex = filteredData.length - 1;
                }
                
                if (filteredData.length === 0) {
                    currentIndex = -1;
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('annotationForm').style.display = 'none';
                } else {
                    displayCurrentItem();
                }
                
                updateStats();
                updateDisplay();
                showSuccess('Item deleted successfully');
            }
        }

        function validateForm() {
            const requiredFields = ['topic', 'scenario', 'question', 'answer', 'explanation'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showError(`Please fill in the ${fieldId} field`);
                    field.focus();
                    return false;
                }
            }
            
            return true;
        }

        function navigateItem(direction) {
            if (filteredData.length === 0) return;
            
            const newIndex = currentIndex + direction;
            if (newIndex >= -1 && newIndex < filteredData.length) {
                currentIndex = newIndex;
                displayCurrentItem();
            }
        }

        function updateNavigation() {
            const counter = document.getElementById('itemCounter');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (filteredData.length === 0) {
                counter.textContent = '0 / 0';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            } else {
                if (currentIndex === -1) {
                    counter.textContent = 'New / ' + filteredData.length;
                } else {
                    counter.textContent = `${currentIndex + 1} / ${filteredData.length}`;
                }
                prevBtn.disabled = currentIndex <= -1;
                nextBtn.disabled = currentIndex === filteredData.length - 1;
            }
        }

        function updateStats() {
            const total = annotationData.length;
            const completed = annotationData.filter(item => 
                item.topic && item.scenario && item.question && item.answer && item.explanation
            ).length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('progressPercent').textContent = 
                total > 0 ? Math.round((completed / total) * 100) + '%' : '0%';
        }

        function applyFilters() {
            const topicFilter = document.getElementById('topicFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredData = annotationData.filter(item => {
                if (topicFilter && item.topic !== topicFilter) return false;
                
                const isCompleted = item.topic && item.scenario && item.question && item.answer && item.explanation;
                if (statusFilter === 'completed' && !isCompleted) return false;
                if (statusFilter === 'incomplete' && isCompleted) return false;
                
                return true;
            });
            
            currentIndex = filteredData.length > 0 ? 0 : -1;
            displayCurrentItem();
            updateNavigation();
        }

        function clearFilters() {
            document.getElementById('topicFilter').value = '';
            document.getElementById('statusFilter').value = '';
            
            filteredData = [...annotationData];
            currentIndex = filteredData.length > 0 ? 0 : -1;
            displayCurrentItem();
            updateNavigation();
        }

        function clearForm() {
            document.getElementById('topic').value = '';
            document.getElementById('scenario').value = '';
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            document.getElementById('explanation').value = '';
            
            document.getElementById('topicExamples').style.display = 'none';
            
            // Reset to new item mode
            currentIndex = -1;
            document.getElementById('addNewBtn').style.display = 'inline-block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            
            updateNavigation();
        }

        async function saveData() {
            if (!currentUser || annotationData.length === 0) {
                showError('No data to save');
                return;
            }
            
            showLoading(true);
            
            try {
                const result = await FirebaseService.saveUserCreatedData(
                    currentUser.userId, 
                    annotationData
                );
                
                if (result.success) {
                    showSuccess('Data saved successfully to Firebase');
                } else {
                    showError('Failed to save data: ' + result.error);
                }
                
            } catch (error) {
                console.error('Save data error:', error);
                showError('Failed to save data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function exportData() {
            if (annotationData.length === 0) {
                showError('No data to export');
                return;
            }
            
            // Create CSV content
            const headers = ['topic', 'scenario', 'question', 'answer', 'explanation', 'createdBy', 'createdAt'];
            const csvContent = [
                headers.join(','),
                ...annotationData.map(item => 
                    headers.map(header => {
                        const value = item[header] || '';
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentUser.userId}_created_annotations_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showSuccess('Data exported successfully');
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    const importedData = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                            const item = {
                                id: generateId(),
                                createdBy: currentUser.userId,
                                createdAt: new Date().toISOString(),
                                lastModified: new Date().toISOString()
                            };
                            
                            headers.forEach((header, index) => {
                                if (values[index]) {
                                    item[header] = values[index];
                                }
                            });
                            
                            importedData.push(item);
                        }
                    }
                    
                    annotationData = [...annotationData, ...importedData];
                    filteredData = [...annotationData];
                    currentIndex = annotationData.length > 0 ? 0 : -1;
                    
                    updateStats();
                    updateDisplay();
                    
                    if (annotationData.length > 0) {
                        document.getElementById('emptyState').style.display = 'none';
                        document.getElementById('annotationForm').style.display = 'block';
                        displayCurrentItem();
                    }
                    
                    showSuccess(`Imported ${importedData.length} items successfully`);
                    
                } catch (error) {
                    showError('Failed to import file: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function updateDisplay() {
            updateNavigation();
        }

        function autoSave() {
            // Auto-save current item if it exists
            if (currentIndex !== -1 && validateForm()) {
                updateCurrentItem();
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const loginBtn = document.getElementById('loginBtn');
            
            if (show) {
                loading.style.display = 'block';
                if (loginBtn) loginBtn.disabled = true;
            } else {
                loading.style.display = 'none';
                if (loginBtn) loginBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Diagnostic Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Firebase Connection Diagnostic Tool</h1>
        
        <div class="test-section">
            <div class="test-title">1. Firebase SDK Loading Test</div>
            <button class="btn" onclick="testFirebaseSDK()">Test Firebase SDK</button>
            <div id="sdkResult"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. Firebase Configuration Test</div>
            <button class="btn" onclick="testFirebaseConfig()">Test Firebase Config</button>
            <div id="configResult"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. FirebaseService Object Test</div>
            <button class="btn" onclick="testFirebaseService()">Test FirebaseService</button>
            <div id="serviceResult"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. Firestore Connection Test</div>
            <button class="btn" onclick="testFirestoreConnection()">Test Firestore Connection</button>
            <div id="firestoreResult"></div>
        </div>

        <div class="test-section">
            <div class="test-title">5. Network & CORS Test</div>
            <button class="btn" onclick="testNetworkAndCORS()">Test Network & CORS</button>
            <div id="networkResult"></div>
        </div>

        <div class="test-section">
            <div class="test-title">6. Complete Upload Test</div>
            <button class="btn btn-success" onclick="testCompleteUpload()">Test Complete Upload Flow</button>
            <div id="uploadResult"></div>
        </div>

        <div class="test-section">
            <div class="test-title">üõ†Ô∏è Troubleshooting Recommendations</div>
            <div id="recommendations"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>

    <script>
        let testResults = {};

        function showResult(elementId, message, type, details = '') {
            const element = document.getElementById(elementId);
            const detailsHtml = details ? `<div class="code-block">${details}</div>` : '';
            element.innerHTML = `<div class="test-result ${type}">${message}</div>${detailsHtml}`;
        }

        function showLoading(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result info"><span class="loading"></span>${message}</div>`;
        }

        async function testFirebaseSDK() {
            showLoading('sdkResult', 'Testing Firebase SDK loading...');
            
            try {
                // Test if Firebase is loaded
                if (typeof firebase === 'undefined') {
                    testResults.sdk = false;
                    showResult('sdkResult', '‚ùå Firebase SDK not loaded', 'error', 
                        'Firebase SDK scripts are not loading properly. Check:\n' +
                        '1. Internet connection\n' +
                        '2. CDN accessibility\n' +
                        '3. Script loading order');
                    return;
                }

                // Test Firebase app
                if (typeof firebase.app === 'undefined') {
                    testResults.sdk = false;
                    showResult('sdkResult', '‚ùå Firebase App module not available', 'error');
                    return;
                }

                // Test Firestore
                if (typeof firebase.firestore === 'undefined') {
                    testResults.sdk = false;
                    showResult('sdkResult', '‚ùå Firebase Firestore module not available', 'error');
                    return;
                }

                testResults.sdk = true;
                showResult('sdkResult', '‚úÖ Firebase SDK loaded successfully', 'success',
                    `Firebase version: ${firebase.SDK_VERSION || 'Unknown'}\n` +
                    `Available modules: ${Object.keys(firebase).join(', ')}`);

            } catch (error) {
                testResults.sdk = false;
                showResult('sdkResult', '‚ùå Firebase SDK test failed', 'error', 
                    `Error: ${error.message}`);
            }
        }

        async function testFirebaseConfig() {
            showLoading('configResult', 'Testing Firebase configuration...');
            
            try {
                // Check if Firebase is initialized
                let app;
                try {
                    app = firebase.app();
                } catch (error) {
                    testResults.config = false;
                    showResult('configResult', '‚ùå Firebase not initialized', 'error',
                        `Error: ${error.message}\n\nCheck firebase-config.js file and initialization code.`);
                    return;
                }

                // Get Firebase config
                const config = app.options;
                
                // Validate required config fields
                const requiredFields = ['apiKey', 'authDomain', 'projectId'];
                const missingFields = requiredFields.filter(field => !config[field]);
                
                if (missingFields.length > 0) {
                    testResults.config = false;
                    showResult('configResult', '‚ùå Firebase configuration incomplete', 'error',
                        `Missing fields: ${missingFields.join(', ')}`);
                    return;
                }

                testResults.config = true;
                showResult('configResult', '‚úÖ Firebase configuration valid', 'success',
                    `Project ID: ${config.projectId}\n` +
                    `Auth Domain: ${config.authDomain}\n` +
                    `API Key: ${config.apiKey.substring(0, 10)}...`);

            } catch (error) {
                testResults.config = false;
                showResult('configResult', '‚ùå Firebase configuration test failed', 'error',
                    `Error: ${error.message}`);
            }
        }

        async function testFirebaseService() {
            showLoading('serviceResult', 'Testing FirebaseService object...');
            
            try {
                // Check if FirebaseService is defined
                if (typeof FirebaseService === 'undefined') {
                    testResults.service = false;
                    showResult('serviceResult', '‚ùå FirebaseService is not defined', 'error',
                        'FirebaseService object is not available. This could be due to:\n' +
                        '1. firebase-config.js not loading properly\n' +
                        '2. Script loading order issues\n' +
                        '3. JavaScript errors preventing object creation');
                    return;
                }

                // Check if FirebaseService has required methods
                const requiredMethods = ['saveAllToCollection', 'loadFromCollection', 'clearCollection'];
                const missingMethods = requiredMethods.filter(method => typeof FirebaseService[method] !== 'function');
                
                if (missingMethods.length > 0) {
                    testResults.service = false;
                    showResult('serviceResult', '‚ùå FirebaseService incomplete', 'error',
                        `Missing methods: ${missingMethods.join(', ')}`);
                    return;
                }

                testResults.service = true;
                const availableMethods = Object.keys(FirebaseService).filter(key => typeof FirebaseService[key] === 'function');
                showResult('serviceResult', '‚úÖ FirebaseService object available', 'success',
                    `Available methods: ${availableMethods.join(', ')}`);

            } catch (error) {
                testResults.service = false;
                showResult('serviceResult', '‚ùå FirebaseService test failed', 'error',
                    `Error: ${error.message}`);
            }
        }

        async function testFirestoreConnection() {
            showLoading('firestoreResult', 'Testing Firestore connection...');
            
            try {
                if (!testResults.sdk || !testResults.config) {
                    showResult('firestoreResult', '‚ö†Ô∏è Cannot test Firestore - previous tests failed', 'warning',
                        'Fix Firebase SDK and configuration issues first.');
                    return;
                }

                // Test Firestore connection by reading a simple document
                const db = firebase.firestore();
                
                // Try to read from a test collection (this will fail gracefully if no permission)
                const testCollection = 'connection_test';
                const startTime = Date.now();
                
                try {
                    await db.collection(testCollection).limit(1).get();
                    const responseTime = Date.now() - startTime;
                    
                    testResults.firestore = true;
                    showResult('firestoreResult', '‚úÖ Firestore connection successful', 'success',
                        `Response time: ${responseTime}ms\n` +
                        `Database URL: ${db.app.options.projectId}.firebaseio.com`);
                        
                } catch (firestoreError) {
                    // Check if it's a permission error (which means connection is working)
                    if (firestoreError.code === 'permission-denied') {
                        testResults.firestore = true;
                        showResult('firestoreResult', '‚úÖ Firestore connection working (permission denied is expected)', 'success',
                            'Connection established but no read permission for test collection.\n' +
                            'This is normal and indicates Firestore is accessible.');
                    } else {
                        throw firestoreError;
                    }
                }

            } catch (error) {
                testResults.firestore = false;
                showResult('firestoreResult', '‚ùå Firestore connection failed', 'error',
                    `Error: ${error.message}\n` +
                    `Code: ${error.code || 'Unknown'}\n\n` +
                    'This could indicate:\n' +
                    '1. Network connectivity issues\n' +
                    '2. Firestore rules blocking access\n' +
                    '3. Invalid project configuration');
            }
        }

        async function testNetworkAndCORS() {
            showLoading('networkResult', 'Testing network and CORS...');
            
            try {
                // Test basic network connectivity to Firebase
                const testUrls = [
                    'https://firestore.googleapis.com',
                    'https://culturalbench.firebaseapp.com'
                ];

                let networkResults = [];
                
                for (const url of testUrls) {
                    try {
                        const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                        networkResults.push(`‚úÖ ${url} - Accessible`);
                    } catch (error) {
                        networkResults.push(`‚ùå ${url} - ${error.message}`);
                    }
                }

                // Check if running on localhost vs served domain
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                const protocol = location.protocol;
                
                let warnings = [];
                if (protocol === 'file:') {
                    warnings.push('‚ö†Ô∏è Running from file:// protocol - may cause CORS issues');
                }
                if (!isLocalhost && protocol !== 'https:') {
                    warnings.push('‚ö†Ô∏è Not using HTTPS - Firebase requires HTTPS in production');
                }

                const resultType = warnings.length > 0 ? 'warning' : 'success';
                const resultMessage = warnings.length > 0 ? 
                    '‚ö†Ô∏è Network accessible with warnings' : 
                    '‚úÖ Network and CORS configuration OK';

                showResult('networkResult', resultMessage, resultType,
                    networkResults.join('\n') + 
                    (warnings.length > 0 ? '\n\nWarnings:\n' + warnings.join('\n') : ''));

            } catch (error) {
                showResult('networkResult', '‚ùå Network test failed', 'error',
                    `Error: ${error.message}`);
            }
        }

        async function testCompleteUpload() {
            showLoading('uploadResult', 'Testing complete upload flow...');
            
            try {
                // Check all prerequisites
                if (!testResults.sdk || !testResults.config || !testResults.service) {
                    showResult('uploadResult', '‚ùå Cannot test upload - prerequisites failed', 'error',
                        'Fix previous test failures first.');
                    return;
                }

                // Test data preparation
                const testData = [{
                    topic: 'test_topic',
                    scenario: 'Test scenario for diagnostic',
                    question: 'Test question?',
                    answer: 'Test answer',
                    explanation: 'Test explanation',
                    uploadedAt: new Date().toISOString(),
                    diagnostic: true
                }];

                // Test FirebaseService.saveAllToCollection
                const result = await FirebaseService.saveAllToCollection('diagnostic_test', testData);
                
                if (result.success) {
                    // Try to clean up the test data
                    try {
                        await FirebaseService.clearCollection('diagnostic_test');
                    } catch (cleanupError) {
                        console.warn('Could not clean up test data:', cleanupError);
                    }
                    
                    showResult('uploadResult', '‚úÖ Complete upload flow working', 'success',
                        'Successfully uploaded and cleaned up test data.\n' +
                        'Your upload functionality should work properly.');
                } else {
                    showResult('uploadResult', '‚ùå Upload flow failed', 'error',
                        `FirebaseService error: ${result.error}\n\n` +
                        'This indicates an issue with the Firebase service methods.');
                }

            } catch (error) {
                showResult('uploadResult', '‚ùå Upload test failed', 'error',
                    `Error: ${error.message}\n\n` +
                    'This could indicate:\n' +
                    '1. Firestore security rules blocking writes\n' +
                    '2. Network connectivity issues\n' +
                    '3. Authentication requirements');
            }
        }

        function updateRecommendations() {
            const recommendations = document.getElementById('recommendations');
            let html = '<div class="info test-result">';
            
            if (!testResults.sdk) {
                html += '<strong>üîß Firebase SDK Issues:</strong><br>';
                html += '‚Ä¢ Check your internet connection<br>';
                html += '‚Ä¢ Verify Firebase CDN is accessible<br>';
                html += '‚Ä¢ Try refreshing the page<br><br>';
            }
            
            if (!testResults.config) {
                html += '<strong>üîß Firebase Configuration Issues:</strong><br>';
                html += '‚Ä¢ Verify firebase-config.js is loading correctly<br>';
                html += '‚Ä¢ Check Firebase project settings<br>';
                html += '‚Ä¢ Ensure API keys are valid<br><br>';
            }
            
            if (!testResults.service) {
                html += '<strong>üîß FirebaseService Issues:</strong><br>';
                html += '‚Ä¢ Check script loading order in HTML<br>';
                html += '‚Ä¢ Verify firebase-config.js defines FirebaseService<br>';
                html += '‚Ä¢ Look for JavaScript console errors<br><br>';
            }
            
            if (!testResults.firestore) {
                html += '<strong>üîß Firestore Connection Issues:</strong><br>';
                html += '‚Ä¢ Check Firestore security rules<br>';
                html += '‚Ä¢ Verify project ID is correct<br>';
                html += '‚Ä¢ Test from different network/device<br><br>';
            }
            
            if (Object.keys(testResults).length === 0) {
                html += 'Run the diagnostic tests above to get specific recommendations.';
            } else if (Object.values(testResults).every(result => result === true)) {
                html += '<strong>‚úÖ All tests passed!</strong><br>';
                html += 'Your Firebase setup appears to be working correctly.<br>';
                html += 'If you\'re still experiencing issues, try:<br>';
                html += '‚Ä¢ Hard refresh (Ctrl+F5 or Cmd+Shift+R)<br>';
                html += '‚Ä¢ Clear browser cache<br>';
                html += '‚Ä¢ Test in incognito/private mode';
            }
            
            html += '</div>';
            recommendations.innerHTML = html;
        }

        // Update recommendations when tests complete
        const originalShowResult = showResult;
        showResult = function(elementId, message, type, details) {
            originalShowResult(elementId, message, type, details);
            setTimeout(updateRecommendations, 100);
        };

        // Initial recommendations
        updateRecommendations();
    </script>
</body>
</html>
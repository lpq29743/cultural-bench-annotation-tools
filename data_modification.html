<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Modification - Cultural Benchmark Annotation Tool</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
            font-size: 16px;
        }
        
        .login-form {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .login-btn:hover {
            background: #0056b3;
        }
        
        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .loading {
            display: none;
            margin: 20px 0;
        }
        
        .loading i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-link {
            margin-top: 20px;
        }
        
        .back-link a {
            color: #007bff;
            text-decoration: none;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
        
        .main-app {
            display: none;
        }
        
        .user-info-bar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1><i class="fas fa-edit"></i> Data Modification</h1>
            <p>Enter your User ID to access data modification tools</p>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i> Validating user permissions...
        </div>
        
        <form id="loginForm" class="login-form">
            <div class="form-group">
                <label for="userId">User ID:</label>
                <input type="text" id="userId" name="userId" required placeholder="Enter your user ID">
            </div>
            
            <button type="submit" id="loginBtn" class="login-btn">
                <i class="fas fa-sign-in-alt"></i> Access Data Modification
            </button>
        </form>
        
        <div class="back-link">
            <a href="index.html"><i class="fas fa-arrow-left"></i> Back to Main App</a> |
            <a href="data_creation.html"><i class="fas fa-plus"></i> Data Creation</a>
        </div>
    </div>

    <!-- Main Application (shown after successful login) -->
    <div id="mainApp" class="main-app">
        <div class="user-info-bar">
            <div class="user-details">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div><strong id="displayUserId">User</strong></div>
                    <div><small id="userRole">Annotator</small> | <small id="accessibleRegions">Regions: N/A</small></div>
                </div>
            </div>
            <button id="logoutBtn" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        
        <div class="container">
            <header class="header">
                <div class="header-content">
                    <h1><i class="fas fa-edit"></i> Data Modification Tool</h1>
                    <div class="header-actions">
                        <button id="loadDataBtn" class="btn btn-primary">
                            <i class="fas fa-download"></i> Load My Data
                        </button>
                        <button id="saveDataBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button id="exportDataBtn" class="btn btn-secondary">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="sidebar">
                    <div class="stats-panel">
                        <h3>Statistics</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Items:</span>
                            <span id="totalCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Completed:</span>
                            <span id="completedCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Accepted:</span>
                            <span id="acceptedCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Revised:</span>
                            <span id="revisedCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Rejected:</span>
                            <span id="rejectedCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Progress:</span>
                            <span id="progressPercent" class="stat-value">0%</span>
                        </div>
                    </div>

                    <div class="filter-panel">
                        <h3>Filters</h3>
                        <div class="filter-group">
                            <label for="topicFilter">Topic:</label>
                            <select id="topicFilter" class="filter-select">
                                <option value="">All Topics</option>
                                <option value="Belief">Belief</option>
                                <option value="Commerce">Commerce</option>
                                <option value="Education">Education</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Finance">Finance</option>
                                <option value="Food">Food</option>
                                <option value="Government">Government</option>
                                <option value="Habitat">Habitat</option>
                                <option value="Health">Health</option>
                                <option value="Heritage">Heritage</option>
                                <option value="Language">Language</option>
                                <option value="Pets">Pets</option>
                                <option value="Science">Science</option>
                                <option value="Social">Social</option>
                                <option value="Travel">Travel</option>
                                <option value="Work">Work</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="statusFilter">Status:</label>
                            <select id="statusFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="incomplete">Incomplete</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="annotationStatusFilter">Annotation:</label>
                            <select id="annotationStatusFilter" class="filter-select">
                                <option value="">All</option>
                                <option value="accept">Accepted</option>
                                <option value="revise">Revised</option>
                                <option value="reject">Rejected</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <button id="clearFilters" class="btn btn-outline">Clear Filters</button>
                    </div>

                    <div class="navigation-panel">
                        <h3>Navigation</h3>
                        <div class="nav-controls">
                            <button id="prevBtn" class="btn btn-outline">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span id="itemCounter" class="item-counter">0 / 0</span>
                            <button id="nextBtn" class="btn btn-outline">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="annotation-area">
                    <div class="annotation-form" id="annotationForm">
                        <!-- Source Excerpt Field -->
                        <div class="form-group">
                            <label for="sourceExcerpt">Source Excerpt:</label>
                            <textarea id="sourceExcerpt" class="form-textarea" rows="3" placeholder="Original source excerpt" readonly></textarea>
                        </div>

                        <!-- Annotation Decision -->
                        <div class="form-group">
                            <label for="annotationStatus">Annotation Decision:</label>
                            <div class="annotation-decision-buttons">
                                <button id="acceptBtn" class="btn btn-decision btn-accept">
                                    <i class="fas fa-check"></i> Accept
                                </button>
                                <button id="reviseBtn" class="btn btn-decision btn-revise">
                                    <i class="fas fa-edit"></i> Revise
                                </button>
                                <button id="rejectBtn" class="btn btn-decision btn-reject">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                            <input type="hidden" id="annotationStatus" value="">
                        </div>

                        <div class="form-group">
                            <label for="topic">Topic:</label>
                            <select id="topic" class="form-select">
                                <option value="">Select a topic</option>
                                <option value="Belief">Belief</option>
                                <option value="Commerce">Commerce</option>
                                <option value="Education">Education</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Finance">Finance</option>
                                <option value="Food">Food</option>
                                <option value="Government">Government</option>
                                <option value="Habitat">Habitat</option>
                                <option value="Health">Health</option>
                                <option value="Heritage">Heritage</option>
                                <option value="Language">Language</option>
                                <option value="Pets">Pets</option>
                                <option value="Science">Science</option>
                                <option value="Social">Social</option>
                                <option value="Travel">Travel</option>
                                <option value="Work">Work</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="scenario">Scenario:</label>
                            <textarea id="scenario" class="form-textarea" rows="3" placeholder="Describe the scenario"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="question">Question:</label>
                            <textarea id="question" class="form-textarea" rows="3" placeholder="Enter the question"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="answer">Answer:</label>
                            <textarea id="answer" class="form-textarea" rows="4" placeholder="Provide the answer"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="explanation">Explanation:</label>
                            <textarea id="explanation" class="form-textarea" rows="4" placeholder="Explain the reasoning"></textarea>
                        </div>

                        <!-- Rejection Reason (only shown when reject is selected) -->
                        <div class="form-group" id="rejectionReasonGroup" style="display: none;">
                            <label for="rejectionReason">Rejection Reason:</label>
                            <select id="rejectionReason" class="form-select">
                                <option value="">Select reason</option>
                                <option value="incorrect_source">Source excerpt contains incorrect information</option>
                                <option value="subjective_source">Source excerpt is subjective, not objective</option>
                                <option value="cannot_revise">Generated sample cannot be reasonably revised</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button id="updateBtn" class="btn btn-primary">
                                <i class="fas fa-check"></i> Update Item
                            </button>
                            <button id="clearFormBtn" class="btn btn-outline">
                                <i class="fas fa-eraser"></i> Clear Form
                            </button>
                        </div>
                    </div>

                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-content">
                            <i class="fas fa-database empty-state-icon"></i>
                            <h3>No Data Available</h3>
                            <p>Click "Load My Data" to fetch your assigned annotation data.</p>
                            <button id="loadDataBtnEmpty" class="btn btn-primary">
                                <i class="fas fa-download"></i> Load My Data
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Check if Firebase and FirebaseService are loaded
        function checkFirebaseService() {
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded');
                showError('Firebase service not available. Please refresh the page and try again.');
                return false;
            }
            
            if (typeof FirebaseService === 'undefined') {
                console.error('FirebaseService not defined');
                showError('Firebase service not loaded. Please refresh the page and try again.');
                return false;
            }
            
            return true;
        }

        // Global variables
        let currentUser = null;
        let annotationData = [];
        let currentIndex = 0;
        let filteredData = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            
            // Check if Firebase is available
            if (!checkFirebaseService()) {
                console.error('Firebase services not available');
                return;
            }
            
            initializeApp();
        });

        function initializeApp() {
            console.log('Initializing application...');
            
            // Set up event listeners
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                console.log('Login form event listener added');
            } else {
                console.error('Login form not found');
            }
            
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('loadDataBtn').addEventListener('click', loadUserData);
            document.getElementById('loadDataBtnEmpty').addEventListener('click', loadUserData);
            document.getElementById('saveDataBtn').addEventListener('click', saveData);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            
            // Navigation
            document.getElementById('prevBtn').addEventListener('click', () => navigateItem(-1));
            document.getElementById('nextBtn').addEventListener('click', () => navigateItem(1));
            
            // Annotation decision buttons
            document.getElementById('acceptBtn').addEventListener('click', () => setAnnotationDecision('accept'));
            document.getElementById('reviseBtn').addEventListener('click', () => setAnnotationDecision('revise'));
            document.getElementById('rejectBtn').addEventListener('click', () => setAnnotationDecision('reject'));
            
            // Form actions
            document.getElementById('updateBtn').addEventListener('click', updateCurrentItem);
            document.getElementById('clearFormBtn').addEventListener('click', clearForm);
            
            // Filters
            document.getElementById('topicFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('annotationStatusFilter').addEventListener('change', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            console.log('App initialization completed');
        }

        async function handleLogin(e) {
            e.preventDefault();
            console.log('Login form submitted');
            
            // Check Firebase service again before proceeding
            if (!checkFirebaseService()) {
                return;
            }
            
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                showError('Please enter a valid User ID');
                return;
            }
            
            console.log('Attempting login for user:', userId);
            showLoading(true);
            hideMessages();
            
            try {
                // Validate user permissions
                console.log('Calling FirebaseService.validateUserWithPermissions...');
                const userResult = await FirebaseService.validateUserWithPermissions(userId);
                console.log('User validation result:', userResult);
                
                if (!userResult.success) {
                    throw new Error(userResult.error || 'User validation failed');
                }
                
                const user = userResult.user;
                console.log('User data:', user);
                
                // Check if user has data modification permissions
                if (!user.canModifyData) {
                    throw new Error('Access denied: You do not have permission to modify data');
                }
                
                // Store current user
                currentUser = user;
                console.log('User login successful');
                
                // Show success and switch to main app
                showSuccess('Login successful! Loading application...');
                
                setTimeout(() => {
                    showMainApp();
                    updateUserInfo();
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function handleLogout() {
            currentUser = null;
            annotationData = [];
            currentIndex = 0;
            filteredData = [];
            
            // Reset form
            document.getElementById('loginForm').reset();
            clearForm();
            
            // Show login screen
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            
            hideMessages();
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            document.getElementById('displayUserId').textContent = currentUser.userId;
            document.getElementById('userRole').textContent = currentUser.role || 'Annotator';
            document.getElementById('accessibleRegions').textContent = 
                'Regions: ' + (currentUser.accessibleCsvs ? currentUser.accessibleCsvs.join(', ') : 'All');
            
            // Set avatar initial
            const avatar = document.getElementById('userAvatar');
            avatar.textContent = currentUser.userId.charAt(0).toUpperCase();
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            showLoading(true);
            
            try {
                // Load data based on user's accessible CSVs
                const result = await FirebaseService.loadUserAnnotationData(currentUser.userId, currentUser.accessibleCsvs);
                
                if (result.success) {
                    annotationData = result.data || [];
                    filteredData = [...annotationData];
                    currentIndex = 0;
                    
                    updateDisplay();
                    updateStats();
                    
                    if (annotationData.length > 0) {
                        document.getElementById('emptyState').style.display = 'none';
                        document.getElementById('annotationForm').style.display = 'block';
                        displayCurrentItem();
                    } else {
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('annotationForm').style.display = 'none';
                    }
                    
                    showSuccess(`Loaded ${annotationData.length} items successfully`);
                } else {
                    showError('Failed to load data: ' + result.error);
                }
                
            } catch (error) {
                console.error('Load data error:', error);
                showError('Failed to load data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayCurrentItem() {
            if (filteredData.length === 0 || currentIndex < 0 || currentIndex >= filteredData.length) {
                clearForm();
                return;
            }
            
            const item = filteredData[currentIndex];
            
            // Fill form fields
            document.getElementById('sourceExcerpt').value = item.source_excerpt || '';
            document.getElementById('topic').value = item.topic || '';
            document.getElementById('scenario').value = item.scenario || '';
            document.getElementById('question').value = item.question || '';
            document.getElementById('answer').value = item.answer || '';
            document.getElementById('explanation').value = item.explanation || '';
            
            // Set annotation status
            const status = item.annotation_status || 'pending';
            setAnnotationDecision(status);
            
            // Show/hide rejection reason
            if (status === 'reject') {
                document.getElementById('rejectionReasonGroup').style.display = 'block';
                document.getElementById('rejectionReason').value = item.rejection_reason || '';
            } else {
                document.getElementById('rejectionReasonGroup').style.display = 'none';
            }
            
            updateNavigation();
        }

        function setAnnotationDecision(decision) {
            // Reset all buttons
            document.querySelectorAll('.btn-decision').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set active button
            const buttons = {
                'accept': document.getElementById('acceptBtn'),
                'revise': document.getElementById('reviseBtn'),
                'reject': document.getElementById('rejectBtn')
            };
            
            if (buttons[decision]) {
                buttons[decision].classList.add('active');
                document.getElementById('annotationStatus').value = decision;
                
                // Show/hide rejection reason
                if (decision === 'reject') {
                    document.getElementById('rejectionReasonGroup').style.display = 'block';
                } else {
                    document.getElementById('rejectionReasonGroup').style.display = 'none';
                }
            }
        }

        function updateCurrentItem() {
            if (filteredData.length === 0 || currentIndex < 0 || currentIndex >= filteredData.length) {
                return;
            }
            
            const item = filteredData[currentIndex];
            
            // Update item with form data
            item.topic = document.getElementById('topic').value;
            item.scenario = document.getElementById('scenario').value;
            item.question = document.getElementById('question').value;
            item.answer = document.getElementById('answer').value;
            item.explanation = document.getElementById('explanation').value;
            item.annotation_status = document.getElementById('annotationStatus').value;
            
            if (item.annotation_status === 'reject') {
                item.rejection_reason = document.getElementById('rejectionReason').value;
            } else {
                delete item.rejection_reason;
            }
            
            // Mark as modified
            item.lastModified = new Date().toISOString();
            item.modifiedBy = currentUser.userId;
            
            updateStats();
            showSuccess('Item updated successfully');
        }

        function navigateItem(direction) {
            if (filteredData.length === 0) return;
            
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < filteredData.length) {
                currentIndex = newIndex;
                displayCurrentItem();
            }
        }

        function updateNavigation() {
            const counter = document.getElementById('itemCounter');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (filteredData.length === 0) {
                counter.textContent = '0 / 0';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            } else {
                counter.textContent = `${currentIndex + 1} / ${filteredData.length}`;
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex === filteredData.length - 1;
            }
        }

        function updateStats() {
            const total = annotationData.length;
            const completed = annotationData.filter(item => 
                item.annotation_status && item.annotation_status !== 'pending'
            ).length;
            const accepted = annotationData.filter(item => item.annotation_status === 'accept').length;
            const revised = annotationData.filter(item => item.annotation_status === 'revise').length;
            const rejected = annotationData.filter(item => item.annotation_status === 'reject').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('acceptedCount').textContent = accepted;
            document.getElementById('revisedCount').textContent = revised;
            document.getElementById('rejectedCount').textContent = rejected;
            document.getElementById('progressPercent').textContent = 
                total > 0 ? Math.round((completed / total) * 100) + '%' : '0%';
        }

        function applyFilters() {
            const topicFilter = document.getElementById('topicFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const annotationFilter = document.getElementById('annotationStatusFilter').value;
            
            filteredData = annotationData.filter(item => {
                if (topicFilter && item.topic !== topicFilter) return false;
                
                if (statusFilter === 'completed' && (!item.annotation_status || item.annotation_status === 'pending')) return false;
                if (statusFilter === 'incomplete' && item.annotation_status && item.annotation_status !== 'pending') return false;
                
                if (annotationFilter && item.annotation_status !== annotationFilter) return false;
                
                return true;
            });
            
            currentIndex = 0;
            displayCurrentItem();
            updateNavigation();
        }

        function clearFilters() {
            document.getElementById('topicFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('annotationStatusFilter').value = '';
            
            filteredData = [...annotationData];
            currentIndex = 0;
            displayCurrentItem();
            updateNavigation();
        }

        function clearForm() {
            document.getElementById('sourceExcerpt').value = '';
            document.getElementById('topic').value = '';
            document.getElementById('scenario').value = '';
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            document.getElementById('explanation').value = '';
            document.getElementById('annotationStatus').value = '';
            document.getElementById('rejectionReason').value = '';
            
            // Reset decision buttons
            document.querySelectorAll('.btn-decision').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('rejectionReasonGroup').style.display = 'none';
        }

        async function saveData() {
            if (!currentUser || annotationData.length === 0) {
                showError('No data to save');
                return;
            }
            
            showLoading(true);
            
            try {
                const result = await FirebaseService.saveUserAnnotationData(
                    currentUser.userId, 
                    annotationData, 
                    'modification'
                );
                
                if (result.success) {
                    showSuccess('Data saved successfully to Firebase');
                } else {
                    showError('Failed to save data: ' + result.error);
                }
                
            } catch (error) {
                console.error('Save data error:', error);
                showError('Failed to save data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function exportData() {
            if (annotationData.length === 0) {
                showError('No data to export');
                return;
            }
            
            // Create CSV content
            const headers = ['source_excerpt', 'topic', 'scenario', 'question', 'answer', 'explanation', 'annotation_status', 'rejection_reason'];
            const csvContent = [
                headers.join(','),
                ...annotationData.map(item => 
                    headers.map(header => {
                        const value = item[header] || '';
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentUser.userId}_modified_annotations_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showSuccess('Data exported successfully');
        }

        function updateDisplay() {
            updateNavigation();
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const loginBtn = document.getElementById('loginBtn');
            
            if (show) {
                loading.style.display = 'block';
                if (loginBtn) loginBtn.disabled = true;
            } else {
                loading.style.display = 'none';
                if (loginBtn) loginBtn.disabled = false;
            }
        }
    </script>
</body>
</html>